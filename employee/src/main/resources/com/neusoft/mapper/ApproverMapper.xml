<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC ".//mybaits.org/DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.neusoft.mapper.ApproverMapper">
    <select id="getAllApprovers" resultType="com.neusoft.vo.Approvers">
        SELECT
        d.id AS deptId,
        d.dept_name AS dept,
        e.name AS employeeName,
        p.permission_name AS permissionName
        FROM permissions p
        JOIN role_permissions rp ON p.id = rp.permission_id
        JOIN roles r ON rp.role_id = r.id
        JOIN user_roles ur ON r.id = ur.role_id
        JOIN users u ON ur.user_id = u.id
        JOIN employees e ON u.employee_id = e.id
        JOIN departments d ON e.dept_id = d.id
        WHERE p.permission_name IN ('假期审批', '考勤审批')
        <if test="deptName != null and deptName != ''">
            AND d.dept_name = #{deptname}   <!-- 注意这里变量名大小写要一致 -->
        </if>
        ORDER BY d.dept_name, p.permission_name
    </select>

    <!-- 删除指定部门指定权限的原有审批员 -->
    <delete id="deleteOldApprover">
        DELETE FROM user_roles ur
            USING users u
        JOIN employees e ON u.employee_id = e.id
            JOIN role_permissions rp ON rp.role_id = ur.role_id
            JOIN permissions p ON rp.permission_id = p.id
        WHERE e.dept_id = #{deptId}
          AND p.permission_name = #{permissionName}
    </delete>

    <!-- 插入新的审批员 -->
    <insert id="insertNewApprover">
        INSERT INTO user_roles(user_id, role_id)
        SELECT u.id, r.id
        FROM users u
                 JOIN roles r ON r.id = (
            SELECT rp.role_id
            FROM role_permissions rp
                     JOIN permissions p ON rp.permission_id = p.id
            WHERE p.permission_name = #{permissionName}
            LIMIT 1
            )
        WHERE u.employee_id = #{employeeId}
    </insert>

</mapper>